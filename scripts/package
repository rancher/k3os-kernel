#!/bin/bash
set -e

source $(dirname $0)/version
cd $(dirname $0)/..

GENERIC_HEADERS_DIR=dist/generic/headers
GENERIC_MAIN_DIR=dist/generic/main
GENERIC_EXTRA_DIR=dist/generic/modules-extra

mkdir -p ${GENERIC_HEADERS_DIR} ${GENERIC_MAIN_DIR} ${GENERIC_EXTRA_DIR}

# headers
dpkg-deb -x build/linux-headers-5.0.*.deb ${GENERIC_HEADERS_DIR}/
dpkg-deb -x build/linux-hwe-5.0-headers-*.deb ${GENERIC_HEADERS_DIR}/

# main modules and vmlinuz and firmware
dpkg-deb -x build/linux-image-unsigned-5.0.*.deb ${GENERIC_MAIN_DIR}
dpkg-deb -x build/linux-modules-5.0*.deb ${GENERIC_MAIN_DIR}
dpkg-deb -x ${DOWNLOADS}/ubuntu-firmware.deb ${GENERIC_MAIN_DIR}

# extra modules
dpkg-deb -x build/linux-modules-extra-5.0*.deb ${GENERIC_EXTRA_DIR}

# package artifacts
mkdir -p dist/artifacts

pushd ${GENERIC_HEADERS_DIR}
time sh -xc "tar cJf ../../artifacts/kernel-headers-generic_${ARCH}.tar.xz ."
popd

pushd ${GENERIC_MAIN_DIR}
time sh -xc "tar cJf ../../artifacts/kernel-generic_${ARCH}.tar.xz ."
popd

pushd ${GENERIC_EXTRA_DIR}
time sh -xc "tar cJf ../../artifacts/kernel-extra-generic_${ARCH}.tar.xz ."
popd
